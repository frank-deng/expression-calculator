!function(e,r){"use strict";"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?module.exports=r():e.Calc=r()}(this,function(){"use strict";var e=[function(e){return!!/^(\-\-)/g.exec(e)&&{type:0}},function(e){var r=/^0x[0-9A-Fa-f]+/g.exec(e);return r?{type:1,value:r[0]}:!!(r=/^[0-9]+(\.[0-9]+)?([Ee][+\-][0-9]+)?/g.exec(e))&&{type:1,value:r[0]}},function(e){var r=/^[A-Za-z_\u0080-\uffff][A-Za-z0-9_\u0080-\uffff]*/g.exec(e);return!!r&&{type:2,value:r[0]}},function(e){var r=/^[+\-\*\/\(\)]/g.exec(e);return!!r&&{type:3,value:r[0]}},function(e){var r=/^\s+/g.exec(e);return!!r&&{type:null,value:r[0]}}],r={"+":{binocular:!0,priority:10,exchangeable:!0,processor:function(e,r){return e+r}},"-":{binocular:!0,priority:10,exchangeable:!1,processor:function(e,r){return e-r}},"*":{binocular:!0,priority:20,exchangeable:!0,processor:function(e,r){return e*r}},"/":{binocular:!0,priority:20,exchangeable:!1,processor:function(e,r){return e/r}},NEG:{binocular:!1,priority:50,processor:function(e){return-e}}},t={START:["N","S","("],N:["B",")","END"],S:["N","("],B:["N","(","S"],"(":["S","N","("],")":[")","B","END"]},n=Error.prototype,i=function(e,r){this.name="SyntaxError",this.message=e,this.stack=(new Error).stack,this.token=r};Object.create(n).constructor=i;var o=function(e,r){this.name="RPNError",this.message=e,this.stack=(new Error).stack,this.token=r};Object.create(n).constructor=o;var a=function(r){for(var t,n=[],o=0;r.length;){for(var a=0;a<e.length;a++)if(!1!==(t=e[a](r))){if(0==t.type)throw new i("Unexpected Character",o);null!==t.type&&(t.pos=o,n.push(t)),o+=t.value.length,r=r.slice(t.value.length);break}if(!t)throw new i("Unexpected Character",o)}return n},u=function(e){return 1==e.type||2==e.type?"N":3==e.type?"("==e.value?"(":")"==e.value?")":r[e.value].binocular?"B":"S":null},l=function(e){for(var r,n="START",o=new Array,a=0;a<e.length;a++){var l=e[a];if(3==l.type&&"-"==l.value&&["N",")"].indexOf(n)<0&&(l.value=e[a].value="NEG"),r=u(l),t[n].indexOf(r)<0)throw new i("Unexpected Token",l);if("("==r)o.push(e[a]);else if(")"==r){if(0==o.length)throw new i("Unmatched Bracket",l);o.pop()}n=r}if(t[n].indexOf("END")<0)throw new i("Unexpected End Of Expression");if(o.length>0)throw new i("Unmatched Bracket",o[o.length-1])},p=function(e,t){for(var n,i=new Array,o=new Array,a=function(e,t){if(t)i.push(e);else{var n=r[e.value];if(n.binocular&&i.length>1&&1==i[i.length-1].type&&1==i[i.length-2].type){var o=i.pop().value,a=i.pop().value;i.push({type:1,value:n.processor(a,o)})}else!n.binocular&&i.length>0&&1==i[i.length-1].type?i.push({type:1,value:n.processor(i.pop().value)}):i.push(e)}},u=0;u<e.length;u++){var l=e[u];if(delete l.pos,1==l.type)l.value=Number(l.value),i.push(l);else if(2==l.type)i.push(l);else if(3==l.type)if(0==o.length||"("==l.value)o.push(l);else if(")"==l.value)for(;(n=o.pop())&&"("!=n.value;)a(n,t);else{for(;o.length>0&&"("!=o[o.length-1].value&&r[o[o.length-1].value].priority>=r[l.value].priority;)a(o.pop(),t);o.push(l)}}for(;n=o.pop();)a(n,t);return i},v=function(){var e=void 0;this.compile=function(r,t){var n=a(r);return l(n),e=p(n,t),this},this.getRPN=function(){return e},this.setRPN=function(t){e=new Array;for(var n=0,i=0;i<t.length;i++){var a=t[i];if(1==a.type){if(isNaN(a.value))throw e=void 0,new o("Invalid Number",a);a.value=Number(a.value),n++}else if(2==a.type){if("string"!=typeof a.value)throw e=void 0,new o("Invalid Variable",a);n++}else{if(3!=a.type)throw e=void 0,new o("Invalid Token",a);var u=r[a.value];if(void 0===u)throw e=void 0,new o("Invalid Operand",a);if(u.binocular){if(n<=1)throw e=void 0,new o("Unexpected Operand",a);n--}else if(0==n)throw e=void 0,new o("Unexpected Operand",a)}e.push({type:a.type,value:a.value})}if(1!=n)throw e=void 0,new o("Invalid RPN",a);return 0==e.length&&(e=void 0),this},this.calc=function(t){if(void 0===e||0==e.length)return!1;if(1==e.length&&1==e[0].type)return e[0].value;for(var n=new Array,i=0;i<e.length;i++){var o=e[i];if(1==o.type)n.push(o.value);else if(2==o.type)void 0===t||isNaN(t[o.value])?n.push(0):n.push(Number(t[o.value]));else if(3==o.type){var a=r[o.value];if(a.binocular){var u=n.pop(),l=n.pop();n.push(a.processor(l,u))}else n.push(a.processor(n.pop()))}}return n[0]}},c=v;return c.SyntaxError=i,c.RPNError=o,c.TOKEN_NUM=1,c.TOKEN_VAR=2,c.TOKEN_OPER=3,c.rpn2Expr=function(e){for(var t=new Array,n=0;n<e.length;n++){var i=e[n];1==i.type||2==i.type?function(e,r){e.push({value:r,priority:void 0})}(t,i.value):3==i.type&&function(e,t){var n=r[t];if(n.binocular){var i,o=e.pop(),a=e.pop();n.exchangeable&&String(a.value)>String(o.value)&&(i=a,a=o,o=i);var u=a.priority<n.priority?"("+a.value+")":a.value;u+=t,u+=o.priority<n.priority?"("+o.value+")":o.value,e.push({value:u,priority:n.priority})}else if("NEG"==t){var l=e[e.length-1];l.value=void 0===l.priority?"-"+l.value:"-("+l.value+")",l.priority=0}}(t,i.value)}return t[0].value},v});