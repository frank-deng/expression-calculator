!function(e,r){"use strict";"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?module.exports=r():e.Calc=r()}(this,function(){"use strict";var e=[function(e){return!!/^(\-\-)/g.exec(e)&&{type:0}},function(e){var r=/^0x[0-9A-Fa-f]+/g.exec(e);return r?{type:1,value:r[0]}:!!(r=/^[0-9]+(\.[0-9]+)?([Ee][+\-][0-9]+)?/g.exec(e))&&{type:1,value:r[0]}},function(e){var r=/^[A-Za-z_\u0080-\uffff][A-Za-z0-9_\u0080-\uffff]*/g.exec(e);return!!r&&{type:2,value:r[0]}},function(e){var r=/^[+\-\*\/\(\)]/g.exec(e);return!!r&&{type:3,value:r[0]}},function(e){var r=/^\s+/g.exec(e);return!!r&&{type:null,value:r[0]}}],r={"+":{binocular:!0,priority:10,exchangeable:!0,processor:function(e,r){return e+r}},"-":{binocular:!0,priority:10,exchangeable:!1,processor:function(e,r){return e-r}},"*":{binocular:!0,priority:20,exchangeable:!0,processor:function(e,r){return e*r}},"/":{binocular:!0,priority:20,exchangeable:!1,processor:function(e,r){return e/r}},NEG:{binocular:!1,priority:50,processor:function(e){return-e}}},t={START:["N","S","("],N:["B",")","END"],S:["N","("],B:["N","(","S"],"(":["S","N","("],")":[")","B","END"]},n=Error.prototype,a=function(e,r){this.name="SyntaxError",this.message=e,this.stack=(new Error).stack,this.token=r},i=a.prototype;i=Object.create(n),i.constructor=a;var o=function(e,r,t){this.name="RPNError",this.message=e,this.stack=(new Error).stack,this.token=r,this.pos=t},u=o.prototype;u=Object.create(n),u.constructor=o;var p=function(r){for(var t,n=[],i=0;r.length;){for(var o=0;o<e.length;o++)if(!1!==(t=e[o](r))){if(0==t.type)throw new a("Unexpected Character",i);null!==t.type&&(t.pos=i,n.push(t)),i+=t.value.length,r=r.slice(t.value.length);break}if(!t)throw new a("Unexpected Character",i)}return n},l=function(e){return 1==e.type||2==e.type?"N":3==e.type?"("==e.value?"(":")"==e.value?")":r[e.value].binocular?"B":"S":null},s=function(e){for(var r,n="START",i=new Array,o=0;o<e.length;o++){var u=e[o];if(3==u.type&&"-"==u.value&&["N",")"].indexOf(n)<0&&(u.value=e[o].value="NEG"),r=l(u),t[n].indexOf(r)<0)throw new a("Unexpected Token",u);if("("==r)i.push(e[o]);else if(")"==r){if(0==i.length)throw new a("Unmatched Bracket",u);i.pop()}n=r}if(t[n].indexOf("END")<0)throw new a("Unexpected End Of Expression");if(i.length>0)throw new a("Unmatched Bracket",i[i.length-1])},c=function(e,t){for(var n,a=new Array,i=new Array,o=function(e,t){if(t)return void a.push(e);var n=r[e.value];if(n.binocular&&a.length>1&&1==a[a.length-1].type&&1==a[a.length-2].type){var i=a.pop().value,o=a.pop().value;a.push({type:1,value:n.processor(o,i)})}else!n.binocular&&a.length>0&&1==a[a.length-1].type?a.push({type:1,value:n.processor(a.pop().value)}):a.push(e)},u=0;u<e.length;u++){var p=e[u];if(delete p.pos,1==p.type)p.value=Number(p.value),a.push(p);else if(2==p.type)a.push(p);else if(3==p.type)if(0==i.length||"("==p.value)i.push(p);else if(")"==p.value)for(;(n=i.pop())&&"("!=n.value;)o(n,t);else{for(;i.length>0&&"("!=i[i.length-1].value&&r[i[i.length-1].value].priority>=r[p.value].priority;)o(i.pop(),t);i.push(p)}}for(;n=i.pop();)o(n,t);return a},v=function(){this.rpnTokens=void 0};v.SyntaxError=a,v.RPNError=o,v.TOKEN_NUM=1,v.TOKEN_VAR=2,v.TOKEN_OPER=3;var f=v.prototype;return f.compile=function(e,r){var t=p(e);return s(t),this.rpnTokens=c(t,r),this},f.getRPN=function(){return this.rpnTokens},f.setRPN=function(e){if(0==e.length)throw new o("Empty RPN");for(var t=0,n=[],a=0;a<e.length;a++){var i=e[a];if(1==i.type){if(isNaN(i.value))throw new o("Invalid Number",i,a);i.value=Number(i.value),t++}else if(2==i.type){if("string"!=typeof i.value)throw new o("Invalid Variable",i,a);t++}else{if(3!=i.type)throw new o("Invalid Token",i,a);var u=r[i.value];if(void 0===u)throw new o("Invalid Operand",i,a);if(u.binocular){if(t<=1)throw new o("Unexpected Operand",i,a);t--}else if(0==t)throw new o("Unexpected Operand",i,a)}n.push({type:i.type,value:i.value})}if(1!=t)throw new o("Invalid RPN");return this.rpnTokens=n,this},f.calc=function(e){var t=this.rpnTokens;if(void 0===t||0==t.length)return!1;if(1==t.length&&1==t[0].type)return t[0].value;for(var n=new Array,a=0;a<t.length;a++){var i=t[a];if(1==i.type)n.push(i.value);else if(2==i.type)void 0===e||isNaN(e[i.value])?n.push(0):n.push(Number(e[i.value]));else if(3==i.type){var o=r[i.value];if(o.binocular){var u=n.pop(),p=n.pop();n.push(o.processor(p,u))}else n.push(o.processor(n.pop()))}}return n[0]},f.getSimplifiedExpr=function(){if(void 0===this.rpnTokens||0==this.rpnTokens.length)return"";for(var e=new Array,t=0;t<this.rpnTokens.length;t++){var n=this.rpnTokens[t];1==n.type||2==n.type?function(e,r){e.push({value:r,priority:100})}(e,n.value):3==n.type&&function(e,t){var n=r[t];if(n.binocular){var a,i=e.pop(),o=e.pop();n.exchangeable&&String(o.value)>String(i.value)&&(a=o,o=i,i=a),o.priority<n.priority&&(o.value="("+o.value+")");var u=o.value+t;if(i.priority>n.priority)u+=i.value;else if(i.priority<n.priority)i.value="("+i.value+")",u+=i.value;else switch(t){case"-":u+=function(e){for(var r=e.split(""),t=0,n=0;n<r.length;n++)switch(e[n]){case"+":0==t&&(r[n]="-");break;case"-":0==t&&(r[n]="+");break;case"(":t++;break;case")":t--}return r.join("")}(i.value);break;case"/":u+=function(e){for(var r=e.split(""),t=0,n=0;n<r.length;n++)switch(e[n]){case"*":0==t&&(r[n]="/");break;case"/":0==t&&(r[n]="*");break;case"(":t++;break;case")":t--}return r.join("")}(i.value);break;default:u+=i.value}e.push({value:u,priority:n.priority})}else{var p=e[e.length-1];"NEG"==t&&(p.value=100==p.priority?"-"+p.value:"-("+p.value+")"),p.priority=0}}(e,n.value)}return e[0].value},v});